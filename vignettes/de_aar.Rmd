---
title: "De Aar PV Plant Forecasting Example"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{De Aar PV Plant Forecasting Example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

This vignette demonstrates the use of the `pvflux` package for modeling the Mulilo De Aar PV solar plant in South Africa. The plant specifications used in this package are **assumed values** based on information documented at the [HAWI Knowledge Database](https://hawiknowledge.org/solar_power_stations_2.html#DeAarMulilo), which compiled these parameters from publicly available documents in the public domain, including Environmental Impact Assessment (EIA) submissions and similar regulatory filings.

The De Aar plant is a ground-mounted photovoltaic installation using Trina TSM-PC05 polycrystalline modules. This vignette explains our modeling choices, demonstrates the complete DC and AC power forecasting pipeline, and shows how to use ensemble analysis to quantify model uncertainty.

## Known Plant Specifications

Based on publicly available information:

- **Location**: De Aar, South Africa (latitude: -30.6279°, longitude: 24.0054°)
- **PV Modules**: Trina Solar TSM-230 PC05 (230W polycrystalline)
  - Total modules: 44,880
  - Total DC capacity: 10.32 MW
  - Module efficiency: 14.1%
  - Temperature coefficient: -0.43%/K
  - NOCT: 45°C
- **Array Configuration**:
  - Tilt angle: 20° (optimized for latitude)
  - Azimuth: 0° (north-facing, Southern Hemisphere)
- **AC Capacity**: ~10 MW (inverter details not publicly available)

## Modeling Approach

### Available Models

The package now provides multiple transposition and cell temperature models:

**Transposition Models:**
- **Olmo et al. (1999)**: Clearness index method, no decomposition required
- **Hay-Davies**: Anisotropic sky model with Erbs decomposition (GHI→DNI/DHI→POA)

**Cell Temperature Models:**
- **Skoplaki**: NOCT-based model with two wind coefficient variants
- **Faiman**: Empirical model adopted in IEC 61853 standards

### PV Module Parameters

The Trina TSM-230 PC05 module specifications are well-documented and provide the foundation for our modeling:

- **Nameplate DC power** (`P_dc0`): 230 W per module
- **Temperature coefficient** (`gamma`): -0.0043 /K (equivalent to -0.43%/K)
- **NOCT**: 45°C (measured at 800 W/m², 20°C ambient, 1 m/s wind)
- **Module efficiency at STC** (`eta_STC`): 0.141 (14.1%)

These parameters are used directly in the PVWatts DC power model and the cell temperature calculations.

### Transposition Model Details

#### Olmo et al. Model

The Olmo model converts GHI to POA using a clearness index approach:

$$I_{\gamma} = I \cdot \psi_o \cdot F_c$$

where:
- $\psi_o = \exp(-k_t(\theta^2 - \theta_z^2))$ is the conversion function based on clearness index $k_t$ and the difference between incidence angle $\theta$ and zenith angle $\theta_z$ (in radians)
- $F_c = 1 + \rho \sin^2(\theta/2)$ is the ground reflection multiplying factor
- $k_t = I/I_0$ is the clearness index (ratio of measured to extraterrestrial irradiance)

This model is computationally efficient and well-suited for locations like De Aar with high direct normal irradiance and clear sky conditions.

#### Hay-Davies Model

The Hay-Davies model explicitly accounts for the anisotropic nature of sky diffuse radiation:

1. **Erbs Decomposition**: Estimates DNI and DHI from GHI using empirical relationships based on the clearness index
2. **Hay-Davies Transposition**: Separates sky diffuse into isotropic and circumsolar components

The sky diffuse irradiance is:

$$I_{d} = DHI \left[ A\cdot R_b + (1 - A) \left(\frac{1 + \cos\beta}{2}\right) \right]$$

where:
- $A = DNI/I_{extra}$ is the anisotropy index
- $R_b = \cos(\theta)/\cos(\theta_z)$ is the projection ratio
- $\beta$ is the tilt angle

### Cell Temperature Model Details

#### Skoplaki Model

Two variants based on different wind convection coefficients:

- **Model 1** (default): $h_w = 8.91 + 2.00 \times v_f$
- **Model 2**: $h_w = 5.7 + 3.8 \times v_w$, where $v_w = 0.68 \times v_f - 0.5$

Both use the full NOCT-based formulation (Equation 41), accounting for:
- Wind speed effects on convection heat transfer
- Module optical properties ($\tau\alpha = 0.9$)
- Temperature-dependent efficiency losses

#### Faiman Model

A simple empirical model adopted in IEC 61853 standards:

$$T_{cell} = T_{amb} + \frac{G_{POA}}{u_0 + u_1 \times v}$$

where:
- $u_0 = 25.0$ W/(m²·°C) is the constant heat loss coefficient
- $u_1 = 6.84$ W/(m²·°C·m/s) is the wind-enhanced heat loss coefficient
- $v$ is the wind speed in m/s

### DC Power Model: PVWatts

The PVWatts DC power model with optional Incidence Angle Modifier (IAM):

$$P_{dc} = P_{dc0} \times \frac{G_{poa} \times IAM}{1000} \times [1 + \gamma \times (T_{cell} - 25)]$$

The IAM accounts for optical losses at high incidence angles:

$$IAM = \cos(\theta)^{0.05}$$

where $\theta$ is the incidence angle. This can correct 1-3% underestimation at low sun angles.

## Setup

```{r setup}
library(pvflux)
library(dplyr)
library(ggplot2)
```

## Site Parameters

```{r site_params}
lat <- -30.6279
lon <- 24.0054
tilt <- 20
azimuth <- 0
P_dc0_plant <- 10322400  # 44880 modules * 230 W
```

## Example Weather Data

For this example, we create a typical summer day profile for De Aar. In practice, these would come from weather forecast models (NWP) or measurement stations.

```{r weather_data}
# 24-hour period starting at midnight (UTC)
time <- seq(as.POSIXct("2026-01-15 00:00", tz = "UTC"),
            length.out = 24, by = "hour")

# Typical summer day GHI profile (W/m²)
# Peak around 1000 W/m² at solar noon
GHI <- c(0, 0, 0, 0, 0, 50, 200, 450, 700, 850, 950, 1000,
         980, 900, 750, 550, 350, 150, 20, 0, 0, 0, 0, 0)

# Typical summer temperature profile (°C)
# De Aar has hot days, cooler nights
T_air <- c(18, 17, 16, 16, 16, 17, 19, 22, 26, 29, 32, 34,
           35, 35, 34, 33, 30, 27, 24, 22, 21, 20, 19, 18)

# Wind speed (m/s) - generally moderate in De Aar
wind <- c(2, 2, 2, 2, 2.5, 3, 3.5, 4, 4.5, 5, 5, 5,
          4.5, 4.5, 4, 4, 3.5, 3, 3, 2.5, 2.5, 2, 2, 2)
```

## Default Pipeline: Olmo + Skoplaki

The default configuration uses Olmo transposition and Skoplaki cell temperature (Model 1):

```{r default_pipeline}
result_default <- pv_power_pipeline(
  time = time,
  lat = lat,
  lon = lon,
  GHI = GHI,
  T_air = T_air,
  wind = wind,
  tilt = tilt,
  azimuth = azimuth,
  P_dc0 = P_dc0_plant,
  n_inverters = 20,
  inverter_kw = 500
)

# Display key results for daylight hours
daylight <- result_default$GHI > 0
result_default[daylight, c("time", "GHI", "G_poa", "T_cell", "P_dc", "P_ac")]
```

## Alternative Model Combinations

The package allows independent selection of transposition and cell temperature models. Let's compare all four combinations:

```{r model_comparison}
# Olmo + Skoplaki (default)
result_olmo_skoplaki <- pv_power_pipeline(
  transposition_model = "olmo",
  cell_temp_model = "skoplaki",
  time = time, lat = lat, lon = lon,
  GHI = GHI, T_air = T_air, wind = wind,
  tilt = tilt, azimuth = azimuth,
  P_dc0 = P_dc0_plant,
  n_inverters = 20, inverter_kw = 500
)

# Olmo + Faiman
result_olmo_faiman <- pv_power_pipeline(
  transposition_model = "olmo",
  cell_temp_model = "faiman",
  time = time, lat = lat, lon = lon,
  GHI = GHI, T_air = T_air, wind = wind,
  tilt = tilt, azimuth = azimuth,
  P_dc0 = P_dc0_plant,
  n_inverters = 20, inverter_kw = 500
)

# Hay-Davies + Skoplaki
result_haydavies_skoplaki <- pv_power_pipeline(
  transposition_model = "haydavies",
  cell_temp_model = "skoplaki",
  time = time, lat = lat, lon = lon,
  GHI = GHI, T_air = T_air, wind = wind,
  tilt = tilt, azimuth = azimuth,
  P_dc0 = P_dc0_plant,
  n_inverters = 20, inverter_kw = 500
)

# Hay-Davies + Faiman
result_haydavies_faiman <- pv_power_pipeline(
  transposition_model = "haydavies",
  cell_temp_model = "faiman",
  time = time, lat = lat, lon = lon,
  GHI = GHI, T_air = T_air, wind = wind,
  tilt = tilt, azimuth = azimuth,
  P_dc0 = P_dc0_plant,
  n_inverters = 20, inverter_kw = 500
)
```

### Comparison at Peak Irradiance

Let's compare the four models at solar noon (hour 12):

```{r peak_comparison}
peak_hour <- 12  # Solar noon
comparison <- data.frame(
  Model = c("Olmo+Skoplaki", "Olmo+Faiman", "Hay-Davies+Skoplaki", "Hay-Davies+Faiman"),
  POA = c(result_olmo_skoplaki$G_poa[peak_hour],
          result_olmo_faiman$G_poa[peak_hour],
          result_haydavies_skoplaki$G_poa[peak_hour],
          result_haydavies_faiman$G_poa[peak_hour]),
  T_Cell = c(result_olmo_skoplaki$T_cell[peak_hour],
            result_olmo_faiman$T_cell[peak_hour],
            result_haydavies_skoplaki$T_cell[peak_hour],
            result_haydavies_faiman$T_cell[peak_hour]),
  P_DC = c(result_olmo_skoplaki$P_dc[peak_hour],
           result_olmo_faiman$P_dc[peak_hour],
           result_haydavies_skoplaki$P_dc[peak_hour],
           result_haydavies_faiman$P_dc[peak_hour]),
  P_AC = c(result_olmo_skoplaki$P_ac[peak_hour],
           result_olmo_faiman$P_ac[peak_hour],
           result_haydavies_skoplaki$P_ac[peak_hour],
           result_haydavies_faiman$P_ac[peak_hour])
)

print(comparison)
```

The Hay-Davies transposition generally yields higher POA irradiance due to its explicit treatment of the circumsolar component, while the Faiman cell temperature model tends to predict slightly higher temperatures.

## Ensemble Analysis

For robustness and uncertainty quantification, the package provides ensemble functions that run all four model combinations:

```{r ensemble}
# Get all model combinations with AC power
ensemble <- pv_power_ensemble(
  time = time,
  lat = lat,
  lon = lon,
  GHI = GHI,
  T_air = T_air,
  wind = wind,
  tilt = tilt,
  azimuth = azimuth,
  P_dc0 = P_dc0_plant,
  n_inverters = 20,
  inverter_kw = 500
)

# View ensemble structure
head(ensemble[, c("time", "model", "transposition", "cell_temp", "P_dc", "P_ac")])
```

### Ensemble Statistics

Calculate ensemble statistics to understand model uncertainty:

```{r ensemble_stats}
ensemble_stats <- ensemble %>%
  filter(GHI > 0) %>%  # Daylight hours only
  group_by(time) %>%
  summarise(
    P_dc_mean = mean(P_dc),
    P_dc_sd = sd(P_dc),
    P_dc_min = min(P_dc),
    P_dc_max = max(P_dc),
    P_ac_mean = mean(P_ac),
    P_ac_sd = sd(P_ac),
    P_ac_min = min(P_ac),
    P_ac_max = max(P_ac),
    P_ac_range = max(P_ac) - min(P_ac),
    .groups = "drop"
  )

# Display peak hours
ensemble_stats[ensemble_stats$P_dc_mean > 1000, ]
```

The ensemble provides a measure of model uncertainty, which can be useful for:
- Risk assessment in forecasting applications
- Communicating confidence intervals
- Understanding model sensitivity

### Visualizing Ensemble Results

```{r ensemble_plot, fig.width = 8, fig.height = 5}
ensemble_daylight <- ensemble[ensemble$GHI > 0, ]

ggplot(ensemble_daylight, aes(x = time, y = P_ac, color = model)) +
  geom_line(linewidth = 1) +
  labs(
    title = "AC Power: Ensemble of 4 Model Combinations",
    subtitle = "De Aar PV Plant",
    x = "Time (UTC)",
    y = "AC Power (W)",
    color = "Model"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r ensemble_spread, fig.width = 8, fig.height = 5}
ggplot(ensemble_stats, aes(x = time)) +
  geom_ribbon(aes(ymin = P_ac_min, ymax = P_ac_max), fill = "lightblue", alpha = 0.5) +
  geom_line(aes(y = P_ac_mean, color = "Mean"), linewidth = 1) +
  labs(
    title = "AC Power Ensemble Spread",
    subtitle = "Shaded area shows min-max range across 4 models",
    x = "Time (UTC)",
    y = "AC Power (W)",
    color = "Statistic"
  ) +
  theme_minimal()
```

## Daily Energy Summary

```{r energy_summary}
# Calculate daily energy for each model
daily_energy <- ensemble %>%
  filter(GHI > 0) %>%
  group_by(model) %>%
  summarise(
    daily_dc_mwh = sum(P_dc) / 1e6,
    daily_ac_mwh = sum(P_ac) / 1e6,
    .groups = "drop"
)

print(daily_energy)

# Ensemble statistics for daily energy
cat(sprintf("\nEnsemble Daily DC Energy: %.2f MWh\n",
            mean(daily_energy$daily_dc_mwh)))
cat(sprintf("Ensemble Daily AC Energy: %.2f MWh\n",
            mean(daily_energy$daily_ac_mwh)))
cat(sprintf("DC Energy Range: %.2f to %.2f MWh (%.1f%% spread)\n",
            min(daily_energy$daily_dc_mwh),
            max(daily_energy$daily_dc_mwh),
            100 * (max(daily_energy$daily_dc_mwh) - min(daily_energy$daily_dc_mwh)) /
              mean(daily_energy$daily_dc_mwh)))
```

## Model Selection Guidance

### Transposition Model Choice

| Factor | Olmo | Hay-Davies |
|--------|------|------------|
| **Complexity** | Lower (no decomposition) | Higher (requires DNI/DHI) |
| **Input Data** | GHI only | GHI only (decomposes internally) |
| **Best For** | Clear sky conditions, high DNI | Variable sky, diffuse conditions |
| **Computational Cost** | Lower | Higher |

### Cell Temperature Model Choice

| Factor | Skoplaki | Faiman |
|--------|----------|--------|
| **Complexity** | Higher (NOCT-based) | Lower (empirical) |
| **Input Data** | POA, T_air, wind, NOCT params | POA, T_air, wind |
| **Best For** | Systems with known NOCT | Quick estimates, IEC compliance |
| **Validation** | Industry standard | IEC 61853 standard |

### Recommended Combinations

For the De Aar plant:
1. **Default**: Olmo + Skoplaki Model 1 (validated, computationally efficient)
2. **Conservative**: Hay-Davies + Skoplaki (higher POA, validated cell temp)
3. **Alternative**: Olmo + Faiman (simple, IEC-compliant cell temp)
4. **High Estimate**: Hay-Davies + Faiman (both models tend toward higher values)

## Incidence Angle Modifier (IAM)

The package includes an optional IAM to account for optical losses at high incidence angles:

```{r iam_comparison}
# With and without IAM
result_with_iam <- pv_power_pipeline(
  iam_exp = 0.05,
  time = time, lat = lat, lon = lon,
  GHI = GHI, T_air = T_air, wind = wind,
  tilt = tilt, azimuth = azimuth,
  P_dc0 = P_dc0_plant,
  n_inverters = 20, inverter_kw = 500
)

result_no_iam <- pv_power_pipeline(
  iam_exp = FALSE,
  time = time, lat = lat, lon = lon,
  GHI = GHI, T_air = T_air, wind = wind,
  tilt = tilt, azimuth = azimuth,
  P_dc0 = P_dc0_plant,
  n_inverters = 20, inverter_kw = 500
)

# Compare at high incidence angles (morning/evening)
iam_comparison <- data.frame(
  time = result_with_iam$time,
  incidence = result_with_iam$incidence,
  P_dc_with_iam = result_with_iam$P_dc,
  P_dc_no_iam = result_no_iam$P_dc,
  diff_W = result_with_iam$P_dc - result_no_iam$P_dc,
  diff_pct = (result_with_iam$P_dc - result_no_iam$P_dc) / result_no_iam$P_dc * 100
)

# Show morning hours where IAM has most effect
iam_comparison[iam_comparison$GHI > 200 & iam_comparison$GHI < 600,
               c("time", "incidence", "diff_W", "diff_pct")]
```

The IAM reduces power output by 1-3% at low sun angles (high incidence angles), improving accuracy for early morning and late afternoon forecasts.

## Discussion

### Limitations and Future Work

Our modeling approach has several limitations that should be considered:

1. **Inverter Model**: The simplified constant-efficiency inverter model does not capture:
   - Efficiency variation with loading
   - Dynamic MPPT behavior
   - Power factor control
   - Voltage-dependent losses

2. **Soiling Losses**: We do not model soiling accumulation on modules. De Aar is in a semi-arid region where soiling can reduce output by 2-5% between cleaning cycles.

3. **Spectral Effects**: The PVWatts model does not account for spectral mismatch effects, which can be important for polycrystalline silicon modules.

4. **Shading**: We assume no shading, which is reasonable for a well-designed ground-mounted plant but should be verified.

5. **Module Degradation**: The model uses nameplate ratings. Actual plants experience degradation of approximately 0.5-0.8% per year.

6. **Bifacial Gain**: If the plant uses bifacial modules (not indicated in available specifications), rear-side irradiance is not modeled.

### Ensemble Benefits

Using ensemble analysis provides several advantages:

1. **Uncertainty Quantification**: The spread across models provides an estimate of structural uncertainty in the forecasting process.

2. **Robustness**: No single model is optimal for all conditions; the ensemble provides a more robust estimate.

3. **Validation**: Ensemble spread can be compared to forecast errors to assess whether model uncertainty is being properly captured.

4. **Communication**: Confidence intervals from ensembles are more meaningful than single-model point forecasts.

## References

- Ayvazoğluyüksel, Ö., & Başaran Filik, Ü. (2018). Estimation methods of global solar radiation, cell temperature and solar power forecasting: A review and case study in Eskişehir. *Renewable and Sustainable Energy Reviews*, 91, 639-653. [https://doi.org/10.1016/j.rser.2018.03.084](https://doi.org/10.1016/j.rser.2018.03.084)

- Corripio, J. G. (2003). Vectorial algebra algorithms for calculating terrain parameters from DEMs and the position of the sun for solar radiation modelling in mountainous terrain. *International Journal of Geographical Information Science*, 17(1), 1-23.

- Erbs, D. G., Klein, S. A., & Duffie, J. A. (1982). Estimation of the diffuse radiation fraction for hourly, daily and monthly-average global radiation. *Solar Energy*, 28(4), 293-302.

- Faiman, D. (2008). Assessing the outdoor operating temperature of photovoltaic modules. *Progress in Photovoltaics*, 16(4), 307-315. [https://doi.org/10.1002/pip.813](https://doi.org/10.1002/pip.813)

- Hay, J. E., & Davies, J. A. (1980). Calculations of the solar radiation incident on an inclined surface. In *Proc. of First Canadian Solar Radiation Data Workshop* (pp. 59). Ministry of Supply and Services, Canada.

- Martin, N., & Ruiz, J. M. (2001). Calculation of the PV modules angular losses under field conditions by means of an analytical model. *Solar Energy Materials and Solar Cells*, 70(1), 25-38. [https://doi.org/10.1016/S0927-0248(00)00404-5](https://doi.org/10.1016/S0927-0248(00)00404-5)

- Olmo, F. J., Vida, J., Foyo, I., Castro-Diez, Y., & Alados-Arboledas, L. (1999). Prediction of global irradiance on inclined surfaces from horizontal global irradiance. *Energy*, 24(8), 689-704. [https://doi.org/10.1016/S0360-5442(99)00025-0](https://doi.org/10.1016/S0360-5442(99)00025-0)

- Skoplaki, E., Boudouvis, A. G., & Palyvos, J. A. (2008). A simple correlation for the operating temperature of photovoltaic modules of arbitrary mounting. *Solar Energy Materials and Solar Cells*, 92(11), 1393-1402. [https://doi.org/10.1016/j.solmat.2008.05.016](https://doi.org/10.1016/j.solmat.2008.05.016)
